# オーバークリティカルシステム

新しく実装された、クリティカル率100%を超えた場合のメカニクスについてのドキュメント。

## システム概要

クリティカル率が100%を超えた場合、以下の3つの段階的なクリティカルが発動する可能性があります。

### 1. 通常のクリティカル（0～100%）
- **条件**: クリティカル率が50%未満（デフォルト）
- **効果**: クリティカル倍率 × 1回適用
- **ログ**: 「クリティカル！」（黄色）

### 2. オーバークリティカル（100～200%）
- **条件**: クリティカル率が100%～200%
- **発動確率**: クリティカル率 - 100%
  - 例：102%なら2%の確率
  - 例：150%なら50%の確率
- **効果**: クリティカル倍率 × 2乗（通常のクリティカルより遥かに高ダメージ）
- **ログ**: 「✨オーバークリティカル！！✨」（金色・輝く）

### 3. オーバークリティカルリミットブレイク（200%超）
- **条件**: クリティカル率が200%を超えている
- **発動確率**: クリティカル率 - 200%
  - 例：205%なら5%の確率
  - 例：250%なら50%の確率
- **効果**: クリティカル倍率 × 3乗（最高威力）
- **ログ**: 「✨✨オーバークリティカルリミットブレイク！！！✨✨」（ピンク・脈動アニメーション）
- **ビジュアル**: 脈動するピンク色のグロー、より豪華な演出

## 計算例

基本的なクリティカル倍率を1.5倍（150%）とした場合：

### 通常攻撃（50%クリティカル率）
- 基本ダメージ: 100
- クリティカル発動時: 100 × 1.5 = **150ダメージ**

### オーバークリティカル（150%クリティカル率）
- 基本ダメージ: 100
- 通常クリティカル確率: 100%
- オーバークリティカル発動確率: 50%（150 - 100）
- オーバークリティカル時: 100 × 1.5² = 100 × 2.25 = **225ダメージ**

### リミットブレイク（220%クリティカル率）
- 基本ダメージ: 100
- 通常クリティカル確率: 100%
- オーバークリティカル発動確率: 100%（220 > 200）
- リミットブレイク発動確率: 20%（220 - 200）
- リミットブレイク時: 100 × 1.5³ = 100 × 3.375 = **337.5ダメージ**（337ダメージ）

## 実装詳細

### ファイル変更

#### 1. **types/index.ts**
- `CriticalType` 型を追加: `'normal' | 'critical' | 'overCritical' | 'limitBreak'`
- `DamageResult` インターフェースに `criticalType?: CriticalType` を追加
- `CombatLogEntry` の type に `'overCritical' | 'limitBreak'` を追加

#### 2. **systems/WeaponSystem.ts**
- `attack()` メソッドのシナジーボーナス型に `resistancePenetrationBonus` と `lifeStealBonus` を追加
- クリティカル判定ロジックを拡張：
  - クリティカル率100%超の場合、オーバークリティカルの判定を追加
  - クリティカル率200%超の場合、リミットブレイクの判定を追加
  - 各段階で異なるダメージ倍率を適用
- `DamageResult` に `criticalType` を含める

#### 3. **systems/CombatSystem.ts**
- ログ出力部分を拡張：
  - `result.criticalType` に応じてログメッセージと色を変更
  - オーバークリティカル: 「✨オーバークリティカル！！✨」
  - リミットブレイク: 「✨✨オーバークリティカルリミットブレイク！！！✨✨」

#### 4. **components/CombatLog.vue**
- `.log-overCritical` スタイル: 輝く金色（#ffdd57）、グロー効果
- `.log-limitBreak` スタイル: ピンク色（#ff6ec7）、脈動アニメーション（`limitBreakPulse`）

## クリティカル率の上げ方

### 武器ステータス
- 武器の `critChance` プロパティで基本クリティカル率を設定

### 状態異常
- `precision` 状態異常が `critChanceModifier` でクリティカル率を上昇させる
- 複数スタックで効果が累積

### シナジーボーナス
- `useGameOrchestrator.ts` で計算されるシナジーボーナスの `critChanceBonus` で追加

## 推奨される構成例

100%以上のクリティカル率を達成するには、以下の組み合わせが考えられます：

1. **高クリティカル率武器選択**: 40～50%の武器を複数装備
2. **precision シナジー活用**: 複数の武器にタグを付与して、シナジー効果でクリティカル率を上昇
3. **precision バフの活用**: 戦闘中に precision 状態異常を自分に付与

例：
- 武器A（30%）+ 武器B（35%）+ 武器C（20%） + precision 4スタック（+60%） = **145%クリティカル率**
  → オーバークリティカルが50%の確率で発動

## テスト方法

1. **高クリティカル率武器の作成**
   - WeaponGenerationSystem で `critChance: 80+` の武器を生成

2. **precision シナジーの発動**
   - 複数の武器に「precise」タグを付与
   - ゲーム内でシナジーボーナスを確認

3. **戦闘中のクリティカル発動確認**
   - CombatLog で各クリティカルタイプが正しく表示されることを確認
   - ダメージが段階的に増加していることを確認

## 注意事項

- クリティカル率の上限は設定されていません（理論上は無制限）
- リミットブレイク発動時の倍率（3乗）は非常に高いため、バランス調整時に注意
- クリティカル倍率（critDamage）が高いほど、オーバークリティカルの威力が大きくなります
